<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="All-forks header and body syncing."><title>smoldot::sync::all_forks - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../static.files/rustdoc-ba5701c5741a7b69.css" id="mainThemeStyle"><div id="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="smoldot" data-themes="" data-resource-suffix="" data-rustdoc-version="1.70.0 (90c541806 2023-05-31)" data-search-js="search-e077946657036a58.js" data-settings-js="settings-298e1ea74db45b39.js" data-settings-css="settings-7bfb4c59cc6bc502.css" data-theme-light-css="light-0f8c037637f9eb3e.css" data-theme-dark-css="dark-1097f8e92a01e3cf.css" data-theme-ayu-css="ayu-614652228113ac93.css" ></div><script src="../../../static.files/storage-62ce34ea385b278a.js"></script><script defer src="../../../static.files/main-f61008743c98d196.js"></script><noscript><link rel="stylesheet" media="(prefers-color-scheme:light)" href="../../../static.files/light-0f8c037637f9eb3e.css"><link rel="stylesheet" media="(prefers-color-scheme:dark)" href="../../../static.files/dark-1097f8e92a01e3cf.css"><link rel="stylesheet" href="../../../static.files/noscript-13285aec31fa243e.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../../../smoldot/index.html"><img class="rust-logo" src="../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2></h2></nav><nav class="sidebar"><a class="logo-container" href="../../../smoldot/index.html"><img class="rust-logo" src="../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2 class="location"><a href="#">Module all_forks</a></h2><div class="sidebar-elems"><section><ul class="block"><li><a href="#reexports">Re-exports</a></li><li><a href="#modules">Modules</a></li><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li></ul></section></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Module <a href="../../index.html">smoldot</a>::<wbr><a href="../index.html">sync</a>::<wbr><a class="mod" href="#">all_forks</a><button id="copy-path" title="Copy item path to clipboard"><img src="../../../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="srclink" href="../../../src/smoldot/sync/all_forks.rs.html#18-2303">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p><em>All-forks</em> header and body syncing.</p>
<h2 id="overview"><a href="#overview">Overview</a></h2>
<p>This state machine holds:</p>
<ul>
<li>A list of sources of blocks, maintained by the API user.</li>
<li>For each source, a list of blocks hashes known by the source.</li>
<li>The latest known finalized block.</li>
<li>A tree of valid non-finalized blocks that all descend from the latest known finalized block.</li>
<li>(if full mode) A list of block headers whose body is currently being downloaded.</li>
<li>A list of block header waiting to be verified and whose ancestry with the latest finalized
block is currently unknown.</li>
</ul>
<p>The state machine has the objective to synchronize the tree of non-finalized blocks with its
equivalent on the sources added by the API user.</p>
<p>Because it is not possible to predict which block in this tree is going to be finalized in
the future, the entire tree needs to be synchronized.</p>
<blockquote>
<p><strong>Example</strong>: If the latest finalized block is block number 4, and the tree contains blocks
5, 6, and 7, and a source announces a block 5 that is different from the
locally-known block 5, a block request will be emitted for this block 5, even
if it is certain that this “other” block 5 will not become the local best
block. This is necessary in case it is this other block 5 that will end up
being finalized.</p>
</blockquote>
<h2 id="full-vs-non-full"><a href="#full-vs-non-full">Full vs non-full</a></h2>
<p>The <a href="struct.Config.html#structfield.full" title="field smoldot::sync::all_forks::Config::full"><code>Config::full</code></a> option configures whether the state machine only holds headers of the
non-finalized blocks (<code>full</code> equal to <code>false</code>), or the headers, and bodies, and storage
(<code>full</code> equal to <code>true</code>).</p>
<p>In full mode, .</p>
<h2 id="bounded-and-unbounded-containers"><a href="#bounded-and-unbounded-containers">Bounded and unbounded containers</a></h2>
<p>It is important to limit the memory usage of this state machine no matter how the
potentially-malicious sources behave.</p>
<p>The state in this state machine can be put into three categories:</p>
<ul>
<li>
<p>Each source of blocks has a certain fixed-size state associated to it (containing for
instance its best block number and height). Each source also has up to one in-flight
request, which might incur more memory usage. Managing this additional request is out of
scope of this module. The user of this module is expected to limit the number of
simultaneous sources.</p>
</li>
<li>
<p>A set of verified blocks that descend from the latest finalized block. This set is
unbounded. The consensus and finalization algorithms of the chain are supposed to limit
the number of possible blocks in this set.</p>
</li>
<li>
<p>A set of blocks that can’t be verified yet. Receiving a block announce inserts an element
in this set. In order to handle situations where a malicious source announces lots of
invalid blocks, this set must be bounded. Once it has reached a certain size, the blocks
with the highest block number are discarded if their parent is also in this set or being
downloaded from a source.</p>
</li>
</ul>
<p>Consequently, and assuming that the number of simultaneous sources is bounded, and that
the consensus and finalization algorithms of the chain are properly configured, malicious
sources can’t indefinitely grow the state in this state machine.
Malicious sources, however, can potentially increase the number of block requests required to
download a long fork. This is, at most, an annoyance, and not a vulnerability.</p>
</div></details><h2 id="reexports" class="small-section-header"><a href="#reexports">Re-exports</a></h2><ul class="item-table"><li><div class="item-name" id="reexport.SourceId"><code>pub use pending_blocks::<a class="struct" href="sources/struct.SourceId.html" title="struct smoldot::sync::all_forks::sources::SourceId">SourceId</a>;</code></div></li></ul><h2 id="modules" class="small-section-header"><a href="#modules">Modules</a></h2><ul class="item-table"><li><div class="item-name"><a class="mod" href="sources/index.html" title="mod smoldot::sync::all_forks::sources">sources</a></div><div class="desc docblock-short">Collection of sources used for the <code>all_forks</code> syncing.</div></li></ul><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.AddBlockOccupied.html" title="struct smoldot::sync::all_forks::AddBlockOccupied">AddBlockOccupied</a></div><div class="desc docblock-short">See <a href="struct.FinishAncestrySearch.html#method.add_block" title="method smoldot::sync::all_forks::FinishAncestrySearch::add_block"><code>FinishAncestrySearch::add_block</code></a> and <a href="enum.AddBlock.html" title="enum smoldot::sync::all_forks::AddBlock"><code>AddBlock</code></a>.</div></li><li><div class="item-name"><a class="struct" href="struct.AddBlockVacant.html" title="struct smoldot::sync::all_forks::AddBlockVacant">AddBlockVacant</a></div><div class="desc docblock-short">See <a href="struct.FinishAncestrySearch.html#method.add_block" title="method smoldot::sync::all_forks::FinishAncestrySearch::add_block"><code>FinishAncestrySearch::add_block</code></a> and <a href="enum.AddBlock.html" title="enum smoldot::sync::all_forks::AddBlock"><code>AddBlock</code></a>.</div></li><li><div class="item-name"><a class="struct" href="struct.AddSourceKnown.html" title="struct smoldot::sync::all_forks::AddSourceKnown">AddSourceKnown</a></div><div class="desc docblock-short">See <a href="enum.AddSource.html" title="enum smoldot::sync::all_forks::AddSource"><code>AddSource</code></a> and <a href="struct.AllForksSync.html#method.prepare_add_source" title="method smoldot::sync::all_forks::AllForksSync::prepare_add_source"><code>AllForksSync::prepare_add_source</code></a>.</div></li><li><div class="item-name"><a class="struct" href="struct.AddSourceOldBlock.html" title="struct smoldot::sync::all_forks::AddSourceOldBlock">AddSourceOldBlock</a></div><div class="desc docblock-short">See <a href="enum.AddSource.html" title="enum smoldot::sync::all_forks::AddSource"><code>AddSource</code></a> and <a href="struct.AllForksSync.html#method.prepare_add_source" title="method smoldot::sync::all_forks::AllForksSync::prepare_add_source"><code>AllForksSync::prepare_add_source</code></a>.</div></li><li><div class="item-name"><a class="struct" href="struct.AddSourceUnknown.html" title="struct smoldot::sync::all_forks::AddSourceUnknown">AddSourceUnknown</a></div><div class="desc docblock-short">See <a href="enum.AddSource.html" title="enum smoldot::sync::all_forks::AddSource"><code>AddSource</code></a> and <a href="struct.AllForksSync.html#method.prepare_add_source" title="method smoldot::sync::all_forks::AllForksSync::prepare_add_source"><code>AllForksSync::prepare_add_source</code></a>.</div></li><li><div class="item-name"><a class="struct" href="struct.AllForksSync.html" title="struct smoldot::sync::all_forks::AllForksSync">AllForksSync</a></div></li><li><div class="item-name"><a class="struct" href="struct.AnnouncedBlockKnown.html" title="struct smoldot::sync::all_forks::AnnouncedBlockKnown">AnnouncedBlockKnown</a></div><div class="desc docblock-short">See <a href="enum.BlockAnnounceOutcome.html" title="enum smoldot::sync::all_forks::BlockAnnounceOutcome"><code>BlockAnnounceOutcome</code></a> and <a href="struct.AllForksSync.html#method.block_announce" title="method smoldot::sync::all_forks::AllForksSync::block_announce"><code>AllForksSync::block_announce</code></a>.</div></li><li><div class="item-name"><a class="struct" href="struct.AnnouncedBlockUnknown.html" title="struct smoldot::sync::all_forks::AnnouncedBlockUnknown">AnnouncedBlockUnknown</a></div><div class="desc docblock-short">See <a href="enum.BlockAnnounceOutcome.html" title="enum smoldot::sync::all_forks::BlockAnnounceOutcome"><code>BlockAnnounceOutcome</code></a> and <a href="struct.AllForksSync.html#method.block_announce" title="method smoldot::sync::all_forks::AllForksSync::block_announce"><code>AllForksSync::block_announce</code></a>.</div></li><li><div class="item-name"><a class="struct" href="struct.Config.html" title="struct smoldot::sync::all_forks::Config">Config</a></div><div class="desc docblock-short">Configuration for the <a href="struct.AllForksSync.html" title="struct smoldot::sync::all_forks::AllForksSync"><code>AllForksSync</code></a>.</div></li><li><div class="item-name"><a class="struct" href="struct.FinalityProofVerify.html" title="struct smoldot::sync::all_forks::FinalityProofVerify">FinalityProofVerify</a></div><div class="desc docblock-short">Finality proof verification to be performed.</div></li><li><div class="item-name"><a class="struct" href="struct.FinishAncestrySearch.html" title="struct smoldot::sync::all_forks::FinishAncestrySearch">FinishAncestrySearch</a></div><div class="desc docblock-short">See <a href="struct.AllForksSync.html#method.finish_ancestry_search" title="method smoldot::sync::all_forks::AllForksSync::finish_ancestry_search"><code>AllForksSync::finish_ancestry_search</code></a>.</div></li><li><div class="item-name"><a class="struct" href="struct.HeaderVerify.html" title="struct smoldot::sync::all_forks::HeaderVerify">HeaderVerify</a></div><div class="desc docblock-short">Header verification to be performed.</div></li><li><div class="item-name"><a class="struct" href="struct.RequestId.html" title="struct smoldot::sync::all_forks::RequestId">RequestId</a></div><div class="desc docblock-short">Identifier for a request in the <a href="struct.AllForksSync.html" title="struct smoldot::sync::all_forks::AllForksSync"><code>super::AllForksSync</code></a>.</div></li><li><div class="item-name"><a class="struct" href="struct.RequestParams.html" title="struct smoldot::sync::all_forks::RequestParams">RequestParams</a></div><div class="desc docblock-short">Information about a blocks request to be performed on a source.</div></li></ul><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2><ul class="item-table"><li><div class="item-name"><a class="enum" href="enum.AddBlock.html" title="enum smoldot::sync::all_forks::AddBlock">AddBlock</a></div><div class="desc docblock-short">Result of calling <a href="struct.FinishAncestrySearch.html#method.add_block" title="method smoldot::sync::all_forks::FinishAncestrySearch::add_block"><code>FinishAncestrySearch::add_block</code></a>.</div></li><li><div class="item-name"><a class="enum" href="enum.AddSource.html" title="enum smoldot::sync::all_forks::AddSource">AddSource</a></div><div class="desc docblock-short">Outcome of calling <a href="struct.AllForksSync.html#method.prepare_add_source" title="method smoldot::sync::all_forks::AllForksSync::prepare_add_source"><code>AllForksSync::prepare_add_source</code></a>.</div></li><li><div class="item-name"><a class="enum" href="enum.AncestrySearchResponseError.html" title="enum smoldot::sync::all_forks::AncestrySearchResponseError">AncestrySearchResponseError</a></div><div class="desc docblock-short">Error when adding a block using <a href="struct.FinishAncestrySearch.html#method.add_block" title="method smoldot::sync::all_forks::FinishAncestrySearch::add_block"><code>FinishAncestrySearch::add_block</code></a>.</div></li><li><div class="item-name"><a class="enum" href="enum.BlockAnnounceOutcome.html" title="enum smoldot::sync::all_forks::BlockAnnounceOutcome">BlockAnnounceOutcome</a></div><div class="desc docblock-short">Outcome of calling <a href="struct.AllForksSync.html#method.block_announce" title="method smoldot::sync::all_forks::AllForksSync::block_announce"><code>AllForksSync::block_announce</code></a>.</div></li><li><div class="item-name"><a class="enum" href="enum.BlockBodyVerify.html" title="enum smoldot::sync::all_forks::BlockBodyVerify">BlockBodyVerify</a></div><div class="desc docblock-short">State of the processing of blocks.</div></li><li><div class="item-name"><a class="enum" href="enum.FinalityProofVerifyOutcome.html" title="enum smoldot::sync::all_forks::FinalityProofVerifyOutcome">FinalityProofVerifyOutcome</a></div><div class="desc docblock-short">Information about the outcome of verifying a finality proof.</div></li><li><div class="item-name"><a class="enum" href="enum.GrandpaCommitMessageOutcome.html" title="enum smoldot::sync::all_forks::GrandpaCommitMessageOutcome">GrandpaCommitMessageOutcome</a></div><div class="desc docblock-short">See <a href="struct.AllForksSync.html#method.grandpa_commit_message" title="method smoldot::sync::all_forks::AllForksSync::grandpa_commit_message"><code>AllForksSync::grandpa_commit_message</code></a>.</div></li><li><div class="item-name"><a class="enum" href="enum.HeaderVerifyError.html" title="enum smoldot::sync::all_forks::HeaderVerifyError">HeaderVerifyError</a></div><div class="desc docblock-short">Error that can happen when verifying a block header.</div></li><li><div class="item-name"><a class="enum" href="enum.HeaderVerifyOutcome.html" title="enum smoldot::sync::all_forks::HeaderVerifyOutcome">HeaderVerifyOutcome</a></div><div class="desc docblock-short">Outcome of calling <a href="struct.HeaderVerify.html#method.perform" title="method smoldot::sync::all_forks::HeaderVerify::perform"><code>HeaderVerify::perform</code></a>.</div></li><li><div class="item-name"><a class="enum" href="enum.ProcessOne.html" title="enum smoldot::sync::all_forks::ProcessOne">ProcessOne</a></div><div class="desc docblock-short">State of the processing of blocks.</div></li></ul></section></div></main></body></html>